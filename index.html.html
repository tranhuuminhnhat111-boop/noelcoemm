<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Magic Christmas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body{margin:0;overflow:hidden;background:#000;font-family:Segoe UI}
#ui{position:absolute;bottom:30px;width:100%;text-align:center;z-index:10}
button{
  padding:15px 50px;border-radius:30px;
  font-size:16px;font-weight:800;
  background:linear-gradient(#d32f2f,#8b0000);
  color:#fff;border:2px solid #ffd700;
  cursor:pointer;
  animation:pulse 1.5s infinite
}
@keyframes pulse{50%{transform:scale(1.05)}}
#camera{position:absolute;top:15px;right:15px;width:120px;height:90px;opacity:.6;transform:scaleX(-1)}
</style>
</head>

<body>

<div id="ui">
  <button onclick="start()">START MAGIC</button>
</div>

<canvas id="camera"></canvas>
<video class="input_video" style="display:none"></video>

<script>
/* ================= CONFIG ================= */

const BASE = location.origin + location.pathname.replace("index.html","");

const IMAGES = [
  BASE + "image1.jpeg",
  BASE + "image2.jpeg",
  BASE + "image3.jpeg",
  BASE + "image4.jpeg",
  BASE + "image5.jpeg"
];

const MUSIC = BASE + "audio.mp3";

/* ================= AUDIO ================= */

const music = new Audio(MUSIC);
music.loop = true;
music.volume = 1;

/* ================= THREE ================= */

let scene,camera,renderer,photos=[];
let state="TREE",select=0;

function init3D(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);
  camera.position.z=80;

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  const light=new THREE.AmbientLight(0xffffff,1);
  scene.add(light);

  const loader=new THREE.TextureLoader();
  const geo=new THREE.PlaneGeometry(10,10);

  IMAGES.forEach((url,i)=>{
    const mat=new THREE.MeshBasicMaterial({
      map:loader.load(url),
      side:THREE.DoubleSide
    });
    const mesh=new THREE.Mesh(geo,mat);
    mesh.visible=false;
    scene.add(mesh);
    photos.push(mesh);
  });

  animate();
}

function animate(){
  requestAnimationFrame(animate);

  if(state==="TREE"){
    photos.forEach(p=>p.visible=false);
  }

  if(state==="EXPLODE"){
    photos.forEach((p,i)=>{
      p.visible=true;
      const a=i*Math.PI*2/photos.length;
      p.position.set(Math.sin(a)*25,0,Math.cos(a)*25);
      p.lookAt(camera.position);
    });
  }

  if(state==="PHOTO"){
    photos.forEach((p,i)=>{
      if(i===select){
        p.visible=true;
        p.position.lerp(new THREE.Vector3(0,0,40),0.1);
        p.scale.lerp(new THREE.Vector3(4,4,4),0.1);
      }else{
        p.visible=false;
      }
    });
  }

  renderer.render(scene,camera);
}

/* ================= MEDIAPIPE ================= */

function start(){
  music.play().catch(()=>{});
  init3D();

  const video=document.querySelector(".input_video");
  const canvas=document.getElementById("camera");
  const ctx=canvas.getContext("2d");

  const hands=new Hands({
    locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });

  hands.setOptions({
    maxNumHands:1,
    minDetectionConfidence:.5,
    minTrackingConfidence:.5
  });

  hands.onResults(res=>{
    if(!res.multiHandLandmarks.length){
      state="TREE";return;
    }

    const lm=res.multiHandLandmarks[0];
    const pinch=Math.hypot(lm[4].x-lm[8].x,lm[4].y-lm[8].y);

    if(pinch<0.05){
      state="PHOTO";
      select=(select+1)%photos.length;
    }else{
      state="EXPLODE";
    }

    ctx.drawImage(res.image,0,0,120,90);
  });

  const cam=new Camera(video,{
    onFrame:async()=>{await hands.send({image:video})},
    width:320,height:240
  });

  cam.start();
}

window.addEventListener("resize",()=>{
  if(!camera)return;
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
